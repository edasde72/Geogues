<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <title>GeoGuessr ƒåR - Custom Maps</title>
    
    <script type="text/javascript" src="https://api.mapy.cz/js/panorama/v1/panorama.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #ed1c24;
            --primary-dark: #c11218;
            --bg-dark: #0f0f0f;
            --glass: rgba(255, 255, 255, 0.95);
        }

        body { margin: 0; padding: 0; height: 100vh; font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; background: var(--bg-dark); }
        #panoCont { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .m-panorama .m-panorama-scene-caption { display: none !important; }

        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.9) 100%);
            z-index: 10000; display: flex; justify-content: center; align-items: center; color: white;
            backdrop-filter: blur(8px);
        }

        .card {
            background: var(--glass); color: #1a1a1a; padding: 30px; border-radius: 24px;
            width: 450px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            max-height: 90vh; overflow-y: auto;
        }

        .card h1 { color: var(--primary); margin: 0; font-size: 2.2em; font-weight: 900; text-transform: uppercase; }
        .subtitle { color: #666; font-size: 0.85em; margin-bottom: 20px; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .menu-item { text-align: left; }
        .full-width { grid-column: span 2; }

        .menu-item label { display: block; font-weight: 700; margin-bottom: 4px; font-size: 0.7em; color: #444; text-transform: uppercase; }

        input[type="text"], input[type="number"], select { 
            width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #e2e8f0; 
            font-size: 0.9em; outline: none; box-sizing: border-box; background: #f8fafc;
        }

        .time-controls { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 5px 10px; border-radius: 10px; border: 2px solid #e2e8f0; }
        #timeSlider { flex: 1; accent-color: var(--primary); }
        
        .inf-btn { background: white; color: #444; width: 30px; height: 30px; border-radius: 8px; border: 1px solid #cbd5e1; cursor: pointer; }
        .inf-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        button { cursor: pointer; border: none; border-radius: 12px; font-weight: 800; transition: 0.2s; text-transform: uppercase; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; font-size: 1em; margin-top: 10px; }
        .btn-editor { background: #4a5568; color: white; width: 100%; padding: 10px; font-size: 0.8em; margin-top: 10px; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(237, 28, 36, 0.3); }

        /* EDITOR UI */
        #editor-ui { display: none; flex-direction: column; width: 600px; }
        #editorMap { width: 100%; height: 400px; border-radius: 15px; margin: 15px 0; border: 3px solid #ddd; }

        #ui-top { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(0,0,0,0.8); color: white; padding: 10px 30px; border-radius: 50px; display: none; gap: 30px; }
        #map-container { position: absolute; bottom: 25px; right: 25px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        #guessMap { width: 300px; height: 220px; border: 5px solid white; border-radius: 20px; transition: 0.3s; }
        #guessMap:hover { width: 500px; height: 350px; }
        .btn-next { background: #10b981; color: white; width: 100%; padding: 15px; display: none; }
        #status-msg { background: white; padding: 15px; border-radius: 15px; display: none; width: 100%; box-sizing: border-box; border-left: 6px solid var(--primary); color: #222; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 9999; }
    </style>
</head>
<body>

    <div id="menu" class="overlay-screen">
        <div class="card" id="main-card">
            <h1>GeoGuessr ƒåR</h1>
            <div class="subtitle">Poznej ƒçesko na vlastn√≠ k≈Ø≈æi</div>
            
            <div class="menu-grid">
                <div class="menu-item full-width">
                    <label>Tv√© jm√©no</label>
                    <input type="text" id="playerName" placeholder="Hr√°ƒç">
                </div>
                
                <div class="menu-item">
                    <label>Mapa</label>
                    <select id="cfgMap">
                        <option value="all">Cel√° ƒåR</option>
                        <option value="cities">Velk√° mƒõsta</option>
                    </select>
                </div>

                <div class="menu-item">
                    <label>Pohyb</label>
                    <select id="cfgMove">
                        <option value="1">Povolen</option>
                        <option value="0">Zak√°z√°n</option>
                    </select>
                </div>

                <div class="menu-item">
                    <label>Kola</label>
                    <input type="number" id="cfgRounds" value="5" min="1" max="10">
                </div>

                <div class="menu-item">
                    <label>ƒåas (s)</label>
                    <div class="time-controls">
                        <input type="range" id="timeSlider" min="10" max="300" step="5" value="60">
                        <span id="timeDisplay">60</span>
                        <button class="inf-btn" id="infToggle">‚àû</button>
                    </div>
                </div>

                <div class="menu-item full-width">
                    <label>K√≥d v√Ωzvy (voliteln√©)</label>
                    <input type="text" id="cfgChallenge" placeholder="Vlo≈æ k√≥d a hraj...">
                </div>
            </div>

            <button class="btn-main" onclick="startGame()">Spustit hru</button>
            <button class="btn-editor" onclick="openEditor()">üõ† Vytvo≈ôit vlastn√≠ mapu</button>
        </div>

        <div class="card" id="editor-ui">
            <h1>Editor Mapy</h1>
            <div class="subtitle">Klikni do mapy a vyber a≈æ 10 m√≠st</div>
            <div id="editorMap"></div>
            <div id="editor-info" style="font-size: 0.8em; margin-bottom: 10px; color: #666;">Vybran√° m√≠sta: 0/10</div>
            <div id="editor-code-box" style="display:none; background:#eee; padding:10px; border-radius:8px; margin-bottom:10px; font-family:monospace; font-size:0.7em; word-break:break-all;"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-editor" style="flex:1; background:#e2e8f0; color:#333;" onclick="closeEditor()">Zpƒõt</button>
                <button class="btn-editor" style="flex:1; background:#10b981;" onclick="generateChallengeCode()">Z√≠skat k√≥d</button>
            </div>
        </div>
    </div>

    <div id="end-screen" class="overlay-screen" style="display: none;">
        <div class="card">
            <h2 id="end-player-name" style="margin:0; opacity:0.6; font-size:0.8em;">KONEC HRY</h2>
            <div style="font-size: 4em; font-weight: 900; color: var(--primary);" id="final-score-val">0</div>
            <div id="final-rank-text" style="font-weight: 800; margin-bottom: 20px;">-</div>
            <div style="background:#f1f5f9; padding:10px; border-radius:12px; border:2px dashed #cbd5e1;">
                <label style="font-size:0.6em; font-weight:bold; color:#888;">K√ìD T√âTO HRY:</label>
                <div id="challenge-output" style="font-family:monospace; font-size:0.7em; word-break:break-all; user-select:all;"></div>
            </div>
            <button class="btn-main" onclick="location.reload()">Menu</button>
        </div>
    </div>

    <div id="loading" class="loading-overlay">
        <div style="width:40px; height:40px; border:4px solid #333; border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s infinite linear;"></div>
        <p style="margin-top:20px; font-weight:800;">NAƒå√çT√ÅN√ç...</p>
    </div>

    <div id="ui-top">
        <div class="stat-item"><span style="font-size:0.6em; opacity:0.6; display:block;">ƒåas</span><span id="timer-val" style="font-weight:800; color:var(--primary);">0:00</span></div>
        <div class="stat-item"><span style="font-size:0.6em; opacity:0.6; display:block;">Kolo</span><span id="round-val" style="font-weight:800;">1/5</span></div>
        <div class="stat-item"><span style="font-size:0.6em; opacity:0.6; display:block;">Body</span><span id="score-val" style="font-weight:800;">0</span></div>
    </div>

    <div id="panoCont"></div>

    <div id="map-container">
        <div id="status-msg"></div>
        <div id="controls" style="width:100%;">
            <button id="guessBtn" class="btn-main" onclick="evaluateGuess()">Potvrdit tip</button>
            <button id="nextBtn" class="btn-next" onclick="nextRound()">Dal≈°√≠ kolo</button>
        </div>
        <div id="guessMap"></div>
    </div>

    <script>
        const apiKey = 'f0v1yILk7F_95Aa_nLPp0r2CUEfFosLnbxoUPZIDIAQ';
        let startPoint, panorama, map, userMarker, correctMarker, line;
        let currentRound = 0, totalScore = 0, timerInterval;
        let challengeCoords = [], isChallenge = false;
        let config = { rounds: 5, time: 60, name: "", move: true, isInfinite: false, mapType: "all" };

        // EDITOR VARIABLES
        let editorMap, editorMarkers = [];

        // SLIDER LOGIC
        const slider = document.getElementById('timeSlider');
        const display = document.getElementById('timeDisplay');
        slider.addEventListener('input', () => { if(!config.isInfinite) display.innerText = slider.value; });
        document.getElementById('infToggle').onclick = () => {
            config.isInfinite = !config.isInfinite;
            display.innerText = config.isInfinite ? '‚àû' : slider.value;
            document.getElementById('infToggle').classList.toggle('active');
        };

        // --- EDITOR FUNCTIONS ---
        function openEditor() {
            document.getElementById('main-card').style.display = 'none';
            document.getElementById('editor-ui').style.display = 'flex';
            if (!editorMap) {
                editorMap = L.map('editorMap').setView([49.8, 15.5], 7);
                L.tileLayer(`https://api.mapy.cz/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${apiKey}`).addTo(editorMap);
                editorMap.on('click', (e) => {
                    if (editorMarkers.length >= 10) return;
                    const m = L.marker([e.latlng.lat, e.latlng.lng]).addTo(editorMap);
                    m.on('click', () => {
                        editorMap.removeLayer(m);
                        editorMarkers = editorMarkers.filter(x => x !== m);
                        updateEditorInfo();
                    });
                    editorMarkers.push(m);
                    updateEditorInfo();
                });
            }
        }

        function updateEditorInfo() {
            document.getElementById('editor-info').innerText = `Vybran√° m√≠sta: ${editorMarkers.length}/10 (kliknut√≠m na znaƒçku ji sma≈æe≈°)`;
        }

        function closeEditor() {
            document.getElementById('main-card').style.display = 'block';
            document.getElementById('editor-ui').style.display = 'none';
        }

        function generateChallengeCode() {
            if (editorMarkers.length === 0) { alert("Vyber aspo≈à jedno m√≠sto!"); return; }
            const coords = editorMarkers.map(m => ({ lat: m.getLatLng().lat, lon: m.getLatLng().lng }));
            const code = btoa(JSON.stringify(coords));
            const box = document.getElementById('editor-code-box');
            box.innerText = code;
            box.style.display = 'block';
            alert("K√≥d vygenerov√°n! Zkop√≠ruj si ho z ≈°ed√©ho pole.");
        }

        // --- GAME FUNCTIONS ---
        function startGame() {
            config.rounds = parseInt(document.getElementById('cfgRounds').value);
            config.time = config.isInfinite ? 0 : parseInt(slider.value);
            config.move = document.getElementById('cfgMove').value === "1";
            config.name = document.getElementById('playerName').value || "Hr√°ƒç";
            config.mapType = document.getElementById('cfgMap').value;
            
            const chalInput = document.getElementById('cfgChallenge').value.trim();
            if (chalInput) {
                try {
                    challengeCoords = JSON.parse(atob(chalInput));
                    config.rounds = challengeCoords.length;
                    isChallenge = true;
                } catch(e) { alert("Neplatn√Ω k√≥d!"); return; }
            }

            document.getElementById('menu').style.display = 'none';
            document.getElementById('ui-top').style.display = 'flex';
            initMap();
            nextRound();
        }

        function initMap() {
            map = L.map('guessMap', { attributionControl: false }).setView([49.8, 15.5], 7);
            L.tileLayer(`https://api.mapy.cz/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${apiKey}`).addTo(map);
            map.on('click', (e) => {
                if (document.getElementById('guessBtn').style.display === 'none') return;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
            });
        }

        async function nextRound() {
            currentRound++;
            if (currentRound > config.rounds) { showEndScreen(); return; }
            clearInterval(timerInterval);
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('guessBtn').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('status-msg').style.display = 'none';
            document.getElementById('round-val').innerText = `${currentRound}/${config.rounds}`;
            
            if (userMarker) map.removeLayer(userMarker);
            if (correctMarker) map.removeLayer(correctMarker);
            if (line) map.removeLayer(line);
            userMarker = null;

            if (isChallenge) {
                startPoint = challengeCoords[currentRound - 1];
            } else {
                let panoInfo = null;
                while(!panoInfo) {
                    let lat, lon;
                    if (config.mapType === 'cities') {
                        const cities = [{lat:50.08,lon:14.42},{lat:49.19,lon:16.60},{lat:49.83,lon:18.28},{lat:49.74,lon:13.37}];
                        const c = cities[Math.floor(Math.random()*cities.length)];
                        lat = c.lat + (Math.random()-0.5)*0.05;
                        lon = c.lon + (Math.random()-0.5)*0.05;
                    } else {
                        lat = 48.6 + Math.random() * 2.4;
                        lon = 12.1 + Math.random() * 6.7;
                    }
                    try {
                        const res = await Panorama.panoramaExists({lat, lon, radius: 5000, apiKey});
                        if (res.exists) panoInfo = res.info;
                    } catch(e){}
                }
                startPoint = { lat: panoInfo.lat, lon: panoInfo.lon };
                challengeCoords.push(startPoint);
            }

            const container = document.getElementById('panoCont');
            container.innerHTML = "";
            panorama = await Panorama.panoramaFromPosition({
                parent: container, lon: startPoint.lon, lat: startPoint.lat, 
                apiKey: apiKey, showNavigation: config.move
            });

            document.getElementById('loading').style.display = 'none';
            if (config.time > 0) startTimer(config.time);
            else document.getElementById('timer-val').innerText = "‚àû";
        }

        function startTimer(s) {
            let left = s;
            const up = () => {
                const m = Math.floor(left/60); const sc = left%60;
                document.getElementById('timer-val').innerText = `${m}:${sc<10?'0':''}${sc}`;
            };
            up();
            timerInterval = setInterval(() => {
                left--; up();
                if (left <= 0) { clearInterval(timerInterval); evaluateGuess(); }
            }, 1000);
        }

        async function evaluateGuess() {
            clearInterval(timerInterval);
            const userPos = userMarker ? userMarker.getLatLng() : {lat: 49.8, lng: 15.5};
            const R = 6371; 
            const dLat = (userPos.lat - startPoint.lat) * Math.PI / 180;
            const dLon = (userPos.lng - startPoint.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(startPoint.lat*Math.PI/180)*Math.cos(userPos.lat*Math.PI/180)*Math.sin(dLon/2)**2;
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const score = Math.round(5000 * Math.exp(-dist / 70));
            totalScore += score;

            const status = document.getElementById('status-msg');
            status.innerHTML = `<b style="color:var(--primary)">+${score} bod≈Ø</b><br><small>Vzd√°lenost: ${dist.toFixed(1)} km</small>`;
            status.style.display = 'block';
            document.getElementById('score-val').innerText = totalScore;
            document.getElementById('guessBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'block';

            correctMarker = L.marker([startPoint.lat, startPoint.lon], { icon: L.icon({ iconUrl: 'https://api.mapy.cz/img/api/marker/drop-green.png', iconSize: [22, 30] }) }).addTo(map);
            line = L.polyline([[userPos.lat, userPos.lng], [startPoint.lat, startPoint.lon]], {color: '#ed1c24', weight: 3, dashArray: '5,5'}).addTo(map);
            map.fitBounds(new L.featureGroup([userMarker || correctMarker, correctMarker]).getBounds(), {padding: [40, 40]});
        }

        function showEndScreen() {
            document.getElementById('ui-top').style.display = 'none';
            document.getElementById('map-container').style.display = 'none';
            document.getElementById('end-player-name').innerText = config.name;
            document.getElementById('final-score-val').innerText = totalScore;
            document.getElementById('challenge-output').innerText = btoa(JSON.stringify(challengeCoords));
            let r = totalScore > (config.rounds * 4000) ? "Legenda" : (totalScore > (config.rounds * 2000) ? "Znalec" : "Turista");
            document.getElementById('final-rank-text').innerText = r;
            document.getElementById('end-screen').style.display = 'flex';
        }

        window.addEventListener('keydown', (e) => { if(e.key === 'Enter' && document.getElementById('guessBtn').style.display !== 'none') evaluateGuess(); });
    </script>
</body>
</html>
