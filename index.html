<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <title>GeoGuessr ƒåR - Slider Pro</title>
    
    <script type="text/javascript" src="https://api.mapy.cz/js/panorama/v1/panorama.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #ed1c24;
            --primary-dark: #c11218;
            --bg-dark: #0f0f0f;
            --glass: rgba(255, 255, 255, 0.95);
        }

        body { margin: 0; padding: 0; height: 100vh; font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; background: var(--bg-dark); }
        #panoCont { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .m-panorama .m-panorama-scene-caption { display: none !important; }

        /* NOV√â MODERN√ç MENU */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.8) 100%),
                        url('https://api.mapy.cz/v1/maptiles/basic/256/8/140/88?apikey=f0v1yILk7F_95Aa_nLPp0r2CUEfFosLnbxoUPZIDIAQ'); /* Pozad√≠ s mapou */
            background-size: cover;
            z-index: 10000; display: flex; justify-content: center; align-items: center; color: white;
            backdrop-filter: blur(8px);
        }

        .card {
            background: var(--glass); color: #1a1a1a; padding: 40px; border-radius: 24px;
            width: 450px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .card h1 { 
            color: var(--primary); margin: 0 0 10px 0; font-size: 2.5em; 
            font-weight: 900; letter-spacing: -1px; text-transform: uppercase;
        }

        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 30px; font-weight: 500; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .menu-item { text-align: left; }
        .full-width { grid-column: span 2; }

        .menu-item label { 
            display: block; font-weight: 700; margin-bottom: 6px; 
            font-size: 0.75em; color: #444; text-transform: uppercase; letter-spacing: 0.5px;
        }

        input[type="text"], input[type="number"], select { 
            width: 100%; padding: 12px 15px; border-radius: 12px; border: 2px solid #e2e8f0; 
            font-size: 0.95em; outline: none; box-sizing: border-box; background: #f8fafc;
            transition: border-color 0.2s; font-family: inherit;
        }

        input:focus, select:focus { border-color: var(--primary); }

        /* SLIDER STYLE */
        .time-controls { 
            display: flex; align-items: center; gap: 12px; background: #f1f5f9; 
            padding: 8px 12px; border-radius: 12px; border: 2px solid #e2e8f0; 
        }
        #timeSlider { flex: 1; accent-color: var(--primary); cursor: pointer; }
        #timeDisplay { font-weight: 800; color: var(--primary); min-width: 45px; text-align: center; font-size: 1.1em;}
        
        .inf-btn { 
            background: white; color: #444; width: 35px; height: 35px; border-radius: 8px; 
            font-size: 1.2em; border: 1px solid #cbd5e1; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; justify-content: center;
        }
        .inf-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* UI PRVKY P≈òI H≈òE */
        #ui-top { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; 
            background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 30px; border-radius: 50px; 
            display: none; gap: 30px; align-items: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-value { font-size: 1.2em; font-weight: 800; display: block; }
        #timer-val { color: var(--primary); }

        #map-container { position: absolute; bottom: 25px; right: 25px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        #guessMap { width: 300px; height: 220px; border: 5px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.4); border-radius: 20px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #guessMap:hover { width: 500px; height: 350px; }
        
        button { cursor: pointer; border: none; border-radius: 14px; font-weight: 800; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 18px; font-size: 1.1em; box-shadow: 0 4px 15px rgba(237, 28, 36, 0.3); }
        .btn-main:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(237, 28, 36, 0.4); }
        .btn-next { background: #10b981; color: white; width: 100%; padding: 18px; display: none; }

        .challenge-box { background: #f8fafc; padding: 12px; border-radius: 12px; margin: 15px 0; border: 2px dashed #cbd5e1; }
        #challenge-output { font-family: 'Courier New', monospace; font-size: 0.75em; word-break: break-all; color: #64748b; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #status-msg { background: white; color: #1a1a1a; padding: 15px; border-radius: 15px; display: none; width: 100%; box-sizing: border-box; border-left: 6px solid var(--primary); text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="menu" class="overlay-screen">
        <div class="card">
            <h1>GeoGuessr ƒåR</h1>
            <div class="subtitle">Poznej kr√°sy ƒåesk√© republiky</div>
            
            <div class="menu-grid">
                <div class="menu-item full-width">
                    <label>Tv√© jm√©no</label>
                    <input type="text" id="playerName" placeholder="Anonymn√≠ cestovatel">
                </div>
                
                <div class="menu-item">
                    <label>Mapa</label>
                    <select id="cfgMap">
                        <option value="all">Cel√° ƒåR</option>
                        <option value="cities">Velk√° mƒõsta</option>
                        <option value="castles">Hrady a z√°mky</option>
                    </select>
                </div>

                <div class="menu-item">
                    <label>Pohyb</label>
                    <select id="cfgMove">
                        <option value="1">Povolen</option>
                        <option value="0">Zak√°z√°n</option>
                    </select>
                </div>

                <div class="menu-item">
                    <label>Kola</label>
                    <input type="number" id="cfgRounds" value="5" min="1" max="10">
                </div>

                <div class="menu-item">
                    <label>ƒåas (s)</label>
                    <div class="time-controls">
                        <input type="range" id="timeSlider" min="10" max="300" step="5" value="60">
                        <span id="timeDisplay">60</span>
                        <button class="inf-btn" id="infToggle">‚àû</button>
                    </div>
                </div>

                <div class="menu-item full-width">
                    <label>K√≥d v√Ωzvy</label>
                    <input type="text" id="cfgChallenge" placeholder="Vlo≈æ k√≥d od kamar√°da...">
                </div>
            </div>

            <button class="btn-main" onclick="startGame()">Hr√°t hru</button>
        </div>
    </div>

    <div id="end-screen" class="overlay-screen" style="display: none;">
        <div class="card">
            <h2 id="end-player-name" style="margin:0; color:#666; font-size: 0.9em;">KONEC HRY</h2>
            <div style="font-size: 4em; font-weight: 900; color: var(--primary); line-height: 1;" id="final-score-val">0</div>
            <div id="final-rank-text" style="font-weight: 800; margin: 10px 0 20px 0; color: #1a1a1a; letter-spacing: 2px; text-transform: uppercase;">-</div>
            <div class="challenge-box">
                <label style="font-size: 0.6em; font-weight: bold; color: #888; display: block; margin-bottom: 5px;">SD√çLEJ V√ùZVU S P≈ò√ÅTELI:</label>
                <div id="challenge-output">Z√≠sk√°v√°m...</div>
            </div>
            <button class="btn-main" onclick="location.reload()">Zkusit znovu</button>
        </div>
    </div>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-weight: 800; letter-spacing: 2px;">HLED√ÅM M√çSTO...</p>
    </div>

    <div id="ui-top">
        <div class="stat-item"><span style="font-size:0.6em; text-transform:uppercase; opacity:0.6; display: block;">ƒåas</span><span id="timer-val" class="stat-value">00:00</span></div>
        <div class="stat-item"><span style="font-size:0.6em; text-transform:uppercase; opacity:0.6; display: block;">Kolo</span><span id="round-val" class="stat-value">1/5</span></div>
        <div class="stat-item"><span style="font-size:0.6em; text-transform:uppercase; opacity:0.6; display: block;">Body</span><span id="score-val" class="stat-value">0</span></div>
    </div>

    <div id="panoCont"></div>

    <div id="map-container">
        <div id="status-msg"></div>
        <div id="controls" style="width: 100%;">
            <button id="guessBtn" class="btn-main" onclick="evaluateGuess()">Potvrdit tip</button>
            <button id="nextBtn" class="btn-next" onclick="nextRound()">Pokraƒçovat ‚û°</button>
        </div>
        <div id="guessMap"></div>
    </div>

    <script type="text/javascript">
        const apiKey = 'f0v1yILk7F_95Aa_nLPp0r2CUEfFosLnbxoUPZIDIAQ';
        let startPoint, panorama, map, userMarker, correctMarker, line;
        let currentRound = 0, totalScore = 0, timerInterval;
        let challengeCoords = [], isChallenge = false;
        let config = { rounds: 5, time: 60, name: "", move: true, isInfinite: false, mapType: "all" };

        // Definice oblast√≠ pro mapy
        const MAP_BOUNDS = {
            all: { lat: [48.6, 51.0], lon: [12.1, 18.8] },
            cities: [ // Centra velk√Ωch mƒõst
                {lat: 50.087, lon: 14.421, name: "Praha"},
                {lat: 49.195, lon: 16.608, name: "Brno"},
                {lat: 49.833, lon: 18.282, name: "Ostrava"},
                {lat: 49.747, lon: 13.377, name: "Plze≈à"},
                {lat: 50.767, lon: 15.056, name: "Liberec"},
                {lat: 50.209, lon: 15.832, name: "Hradec Kr√°lov√©"}
            ],
            castles: [ // V√Ωbƒõr hrad≈Ø
                {lat: 49.939, lon: 13.951}, // Karl≈°tejn
                {lat: 48.885, lon: 16.812}, // Lednice
                {lat: 50.060, lon: 13.885}, // K≈ôivokl√°t
                {lat: 50.516, lon: 15.138}, // Trosky
                {lat: 48.812, lon: 14.315}  // ƒåesk√Ω Krumlov
            ]
        };

        const slider = document.getElementById('timeSlider');
        const display = document.getElementById('timeDisplay');
        const infToggle = document.getElementById('infToggle');

        slider.addEventListener('input', () => {
            if (config.isInfinite) toggleInfinite(false);
            display.innerText = slider.value;
        });

        infToggle.addEventListener('click', () => {
            toggleInfinite(!config.isInfinite);
        });

        function toggleInfinite(force) {
            config.isInfinite = force;
            if (config.isInfinite) {
                infToggle.classList.add('active');
                display.innerText = '‚àû';
                slider.style.opacity = '0.3';
                slider.disabled = true;
            } else {
                infToggle.classList.remove('active');
                display.innerText = slider.value;
                slider.style.opacity = '1';
                slider.disabled = false;
            }
        }

        function startGame() {
            config.rounds = parseInt(document.getElementById('cfgRounds').value);
            config.time = config.isInfinite ? 0 : parseInt(slider.value);
            config.move = document.getElementById('cfgMove').value === "1";
            config.name = document.getElementById('playerName').value || "Hr√°ƒç";
            config.mapType = document.getElementById('cfgMap').value;
            
            const chalInput = document.getElementById('cfgChallenge').value.trim();
            if (chalInput) {
                try {
                    challengeCoords = JSON.parse(atob(chalInput));
                    config.rounds = challengeCoords.length;
                    isChallenge = true;
                } catch(e) { alert("Neplatn√Ω k√≥d!"); return; }
            }

            document.getElementById('menu').style.display = 'none';
            document.getElementById('ui-top').style.display = 'flex';
            document.getElementById('controls').style.display = 'flex';
            initMap();
            nextRound();
        }

        function initMap() {
            map = L.map('guessMap', { attributionControl: false }).setView([49.8, 15.5], 7);
            L.tileLayer(`https://api.mapy.cz/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${apiKey}`).addTo(map);
            map.on('click', (e) => {
                if (document.getElementById('guessBtn').style.display === 'none') return;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
            });
        }

        async function nextRound() {
            currentRound++;
            if (currentRound > config.rounds) { showEndScreen(); return; }
            clearInterval(timerInterval);
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('guessBtn').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('status-msg').style.display = 'none';
            document.getElementById('round-val').innerText = `${currentRound}/${config.rounds}`;
            if (userMarker) map.removeLayer(userMarker);
            if (correctMarker) map.removeLayer(correctMarker);
            if (line) map.removeLayer(line);
            userMarker = null;

            if (isChallenge) {
                startPoint = challengeCoords[currentRound - 1];
            } else {
                let panoInfo = null;
                while(!panoInfo) {
                    let lat, lon;
                    if (config.mapType === 'all') {
                        lat = 48.6 + Math.random() * 2.4;
                        lon = 12.1 + Math.random() * 6.7;
                    } else {
                        const pool = MAP_BOUNDS[config.mapType];
                        const center = pool[Math.floor(Math.random() * pool.length)];
                        lat = center.lat + (Math.random() - 0.5) * 0.02; // Rozptyl v okol√≠ bodu
                        lon = center.lon + (Math.random() - 0.5) * 0.02;
                    }
                    
                    try {
                        const res = await Panorama.panoramaExists({lat, lon, radius: 4000, apiKey});
                        if (res.exists) panoInfo = res.info;
                    } catch(e){}
                }
                startPoint = { lat: panoInfo.lat, lon: panoInfo.lon };
                challengeCoords.push(startPoint);
            }

            const container = document.getElementById('panoCont');
            container.innerHTML = "";
            panorama = await Panorama.panoramaFromPosition({
                parent: container, lon: startPoint.lon, lat: startPoint.lat, 
                apiKey: apiKey, showNavigation: config.move
            });

            document.getElementById('loading').style.display = 'none';
            if (config.time > 0) startTimer(config.time);
            else document.getElementById('timer-val').innerText = "‚àû";
        }

        function startTimer(seconds) {
            let timeLeft = seconds;
            updateTimerDisplay(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) { clearInterval(timerInterval); evaluateGuess(); }
            }, 1000);
        }

        function updateTimerDisplay(s) {
            const mins = Math.floor(s / 60); const secs = s % 60;
            document.getElementById('timer-val').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        async function evaluateGuess() {
            clearInterval(timerInterval);
            const userPos = userMarker ? userMarker.getLatLng() : {lat: 49.8, lng: 15.5};
            const R = 6371; 
            const dLat = (userPos.lat - startPoint.lat) * Math.PI / 180;
            const dLon = (userPos.lng - startPoint.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(startPoint.lat*Math.PI/180)*Math.cos(userPos.lat*Math.PI/180)*Math.sin(dLon/2)**2;
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const score = Math.round(5000 * Math.exp(-dist / 70));
            totalScore += score;

            let locText = "Nezn√°m√© m√≠sto";
            try {
                const res = await fetch(`https://api.mapy.cz/v1/geocode/reverse?lon=${startPoint.lon}&lat=${startPoint.lat}&apikey=${apiKey}`);
                const data = await res.json();
                if (data.items.length > 0) locText = `${data.items[0].address.municipality}, ${data.items[0].address.region}`;
            } catch(e) {}

            const status = document.getElementById('status-msg');
            status.innerHTML = `<div style="font-weight:900; color:#ed1c24; font-size:1.2em;">+${score} bod≈Ø</div><div>Vzd√°lenost: ${dist.toFixed(1)} km</div><div style="font-size:0.8em; color:#888; border-top:1px solid #eee; margin-top:5px; padding-top:5px;">üìç ${locText}</div>`;
            status.style.display = 'block';
            
            document.getElementById('score-val').innerText = totalScore;
            document.getElementById('guessBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'block';

            correctMarker = L.marker([startPoint.lat, startPoint.lon], { icon: L.icon({ iconUrl: 'https://api.mapy.cz/img/api/marker/drop-green.png', iconSize: [22, 30] }) }).addTo(map);
            line = L.polyline([[userPos.lat, userPos.lng], [startPoint.lat, startPoint.lon]], {color: '#ed1c24', weight: 3, dashArray: '5,5'}).addTo(map);
            map.fitBounds(new L.featureGroup([userMarker || correctMarker, correctMarker]).getBounds(), {padding: [40, 40]});
        }

        function showEndScreen() {
            document.getElementById('ui-top').style.display = 'none';
            document.getElementById('map-container').style.display = 'none';
            document.getElementById('end-player-name').innerText = config.name;
            document.getElementById('final-score-val').innerText = totalScore;
            document.getElementById('challenge-output').innerText = btoa(JSON.stringify(challengeCoords));
            let r = totalScore > (config.rounds * 4000) ? "Legenda" : (totalScore > (config.rounds * 2000) ? "Znalec" : "Turista");
            document.getElementById('final-rank-text').innerText = r;
            document.getElementById('end-screen').style.display = 'flex';
        }
    </script>
</body>
</html>
